#!/bin/bash

function down (){
  docker stop carbondoomsday-app carbondoomsday-postgresql 2>/dev/null
  docker rm carbondoomsday-app carbondoomsday-postgresql 2>/dev/null
  docker network rm carbondoomsday-network 2>/dev/null
}

function network (){
  docker network create carbondoomsday-network
}

function runner (){
  docker run -itd \
    --name carbondoomsday-postgresql -p 5432:5432 \
    --net carbondoomsday-network --net-alias carbondoomsday-postgresql \
    -e POSTGRES_USER=postgres -e POSTGRES_DB=carbondoomsday -e POSTGRES_PASSWORD=passw0rd \
    postgres:9.6

  docker run -itd \
    --name carbondoomsday-app -p 8089:8089 \
    --net carbondoomsday-network --net-alias carbondoomsday-app \
    --env-file ../carbondoomsday.env -v "$PWD":/scripts \
    decentral1se/carbondoomsday:latest
}

function migrate (){
  docker exec carbondoomsday-app /scripts/wait carbondoomsday-postgresql:5432
  docker exec carbondoomsday-app python manage.py migrate
}

function scrape (){
  docker exec carbondoomsday-app python manage.py scrape_latest
  echo "Successfully scraped latest data."
}

function server (){
  docker exec --detach carbondoomsday-app python manage.py runserver 0.0.0.0:8089
  docker exec carbondoomsday-app /scripts/wait carbondoomsday-app:8089 -- echo "Server is available at http://127.0.0.1:8089/"
}

function up (){
  down
  network
  runner
  migrate
  scrape
  server
}

"$@"
